<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>업무 관리 대시보드</title>
  <style>
    body { font-family: Arial, sans-serif; }
    section { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; }
    pre { background-color: #f4f4f4; padding: 10px; }
    .section-title { font-weight: bold; margin-bottom: 5px; }
    .input-group { margin-bottom: 5px; }
    #global-date-section { display: flex; align-items: center; gap: 10px; }
    
    /* 배너 및 버튼 스타일 */
    #header-banner { display: flex; justify-content: space-between; padding: 10px; background-color: #f0f0f0; }
    #header-banner button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="header-banner">
    <button onclick="window.location.href='/front_for_pro'">프로</button>
    <button onclick="window.location.href='/admin'">어드민</button>
  </div>
  <h1>업무 관리 대시보드</h1>

  <!-- 전역 날짜 및 훈련과정명 선택 섹션 -->
  <section id="global-date-section">
    <div class="section-title">날짜 선택</div>
    <input type="date" id="global-date">
    <div class="section-title">훈련과정명</div>
    <select id="training-course">
      <option value="데이터 분석 스쿨">데이터 분석 스쿨</option>
      <option value="클라우드 스쿨">클라우드 스쿨</option>
      <option value="게임 스쿨">게임 스쿨</option>
    </select>
  </section>

  <!-- 공지사항 섹션 -->
  <section id="notices-section">
    <div class="section-title">공지사항</div>
    <div id="notices" class="notices">
      <!-- 공지사항 내용은 이곳에 동적으로 로드됨 -->
    </div>
  </section>

  <!-- 전달사항 섹션 -->
  <section id="remarks-section">
    <div class="section-title">전달사항</div>
    <div id="remarks" class="remarks">
      <!-- 전달사항 내용은 이곳에 동적으로 로드됨 -->
    </div>
  </section>

  <!-- 교강사 출퇴근 체크 섹션 (교강사 1) -->
  <section id="attendance-section-1">
    <div class="section-title">주강사 출퇴근 체크</div>
    <div class="input-group">
      <label for="check-in-1">출근 시간:</label>
      <input type="time" id="check-in-1">
    </div>
    <div class="input-group">
      <label for="check-out-1">퇴근 시간:</label>
      <input type="time" id="check-out-1">
    </div>
    <div class="input-group">
      <label>
        <input type="checkbox" id="daily-log-1"> 일지 작성 완료
      </label>
    </div>
    <button onclick="saveAttendance1()">주강사 출퇴근 기록 저장</button>
  </section>

  <!-- 교강사 출퇴근 체크 섹션 (교강사 2) -->
  <section id="attendance-section-2">
    <div class="section-title">보조강사 출퇴근 체크</div>
    <div class="input-group">
      <label for="check-in-2">출근 시간:</label>
      <input type="time" id="check-in-2">
    </div>
    <div class="input-group">
      <label for="check-out-2">퇴근 시간:</label>
      <input type="time" id="check-out-2">
    </div>
    <div class="input-group">
      <label>
        <input type="checkbox" id="daily-log-2"> 일지 작성 완료
      </label>
    </div>
    <button onclick="saveAttendance2()">보조강사 출퇴근 기록 저장</button>
  </section>

<!-- 출퇴근 기록 다운로드 섹션 -->
<section id="attendance-download-section">
  <div class="section-title">출퇴근 기록 다운로드</div>
  <!-- <button onclick="downloadAttendance('json')">출퇴근 기록 조회</button> -->
  <!-- <button onclick="downloadAttendance('csv')">CSV 다운로드</button> -->
  <button onclick="downloadAttendance('excel')">Excel 다운로드</button>
</section>

  <!-- 업무 체크리스트 섹션 -->
  <section id="tasks-section">
    <div class="section-title">업무 체크리스트</div>
    <div id="task-list"></div>
    <button onclick="saveTaskSelections()">✅ 체크리스트 저장</button>
  </section>

  <!-- 이슈사항 입력 섹션 추가 -->
  <section id="issue-section">
    <div class="section-title">이슈사항 작성</div>
    <textarea id="issue-text" placeholder="이슈 사항을 입력하세요."></textarea>
    <button onclick="saveIssue()">저장</button>
  </section>

  <!-- 미체크 항목 설명 입력 섹션 -->
  <section id="unchecked-description-section">
    <div class="section-title">미체크 항목에 대한 설명</div>
    <textarea id="unchecked-description-text" placeholder="미체크된 항목에 대한 설명을 입력하세요."></textarea>
    <button onclick="saveUncheckedDescription()">저장</button>
  </section>


  <script>
    let taskSelections = {}; // 체크 상태 저장 객체

    // ✅ 공지사항 및 전달사항 불러오기
    async function fetchNoticesAndRemarks() {
      try {
        const response = await fetch('/notices');
        const result = await response.json();

        if (result.success) {
          const notices = result.data.notices || [];
          const noticesDiv = document.getElementById('notices');
          noticesDiv.innerHTML = ""; // 기존 내용을 초기화

          notices.forEach(notice => {
            // ✅ 전달사항은 공지사항 영역에 추가하지 않음
            if (notice[1] !== '전달사항') {
              const noticeItem = document.createElement('div');
              noticeItem.innerHTML = `
                <h4>${notice[1]}</h4> <!-- title -->
                <p>${notice[2]}</p>  <!-- content -->
                <small>작성일: ${notice[3]}</small>
              `;
              noticesDiv.appendChild(noticeItem);
            }
          });

          // ✅ 전달사항을 따로 표시
          const remarks = result.data.remarks || [];
          const remarksDiv = document.getElementById('remarks');
          remarksDiv.innerHTML = ""; // 기존 내용을 초기화

          remarks.forEach(remark => {
            const remarkItem = document.createElement('div');
            remarkItem.innerHTML = `
              <h4>${remark[1]}</h4>
              <p>${remark[2]}</p>
              <small>작성일: ${remark[3]}</small>
            `;
            remarksDiv.appendChild(remarkItem);
          });
        } else {
          document.getElementById('notices').innerText = "공지사항을 불러오지 못했습니다.";
          document.getElementById('remarks').innerText = "전달사항을 불러오지 못했습니다.";
        }
      } catch (error) {
        document.getElementById('notices').innerText = "오류 발생: " + error;
        document.getElementById('remarks').innerText = "오류 발생: " + error;
      }
    }



    // 페이지 로드 시 공지사항과 전달사항을 불러옴
    fetchNoticesAndRemarks();

    // ✅ 교강사 1 출퇴근 기록 저장
    async function saveAttendance1() {
      const globalDate = document.getElementById('global-date').value;
      const training_course = document.getElementById('training-course').value;
      const check_in = document.getElementById('check-in-1').value;
      const check_out = document.getElementById('check-out-1').value;
      const daily_log = document.getElementById('daily-log-1').checked;

      if (!globalDate || !check_in || !check_out) {
        alert("날짜, 출근, 퇴근 시간을 모두 입력해주세요.");
        return;
      }

      try {
        const response = await fetch('/attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            date: globalDate, 
            instructor: "1", 
            training_course, 
            check_in, 
            check_out, 
            daily_log 
          })
        });
        const result = await response.json();
        if(response.ok && result.success) {
          alert("교강사 1 " + result.message);
        } else {
          alert("교강사 1 출퇴근 기록 저장에 실패했습니다.");
        }
      } catch (error) {
        alert("오류 발생: " + error);
      }
    }

    // ✅ 교강사 2 출퇴근 기록 저장
    async function saveAttendance2() {
      const globalDate = document.getElementById('global-date').value;
      const training_course = document.getElementById('training-course').value;
      const check_in = document.getElementById('check-in-2').value;
      const check_out = document.getElementById('check-out-2').value;
      const daily_log = document.getElementById('daily-log-2').checked;

      if (!globalDate || !check_in || !check_out) {
        alert("날짜, 출근, 퇴근 시간을 모두 입력해주세요.");
        return;
      }

      try {
        const response = await fetch('/attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            date: globalDate, 
            instructor: "2", 
            training_course, 
            check_in, 
            check_out, 
            daily_log 
          })
        });
        const result = await response.json();
        if(response.ok && result.success) {
          alert("교강사 2 " + result.message);
        } else {
          alert("교강사 2 출퇴근 기록 저장에 실패했습니다.");
        }
      } catch (error) {
        alert("오류 발생: " + error);
      }
    }

  // ✅ 출퇴근 기록 조회 및 다운로드 함수
  async function downloadAttendance(format) {
    try {
      const response = await fetch(`/attendance?format=${format}`, {
        method: 'GET'
      });

      if (!response.ok) {
        throw new Error('출퇴근 기록을 불러올 수 없습니다.');
      }

      if (format === 'json') {
        const data = await response.json();
        console.log("출퇴근 기록:", data);
        alert("출퇴근 기록이 콘솔에 출력되었습니다.");
      } else {
        // CSV 또는 Excel 다운로드
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = format === 'csv' ? "출퇴근_기록.csv" : "출퇴근_기록.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    } catch (error) {
      console.error("다운로드 오류:", error);
      alert("출퇴근 기록을 다운로드할 수 없습니다.");
    }
  }

    // ✅ 체크리스트 불러오기 (중복 제거)
    async function fetchTasks() {
      try {
        const response = await fetch('/tasks');
        const result = await response.json();
        if(result.success) {
          const tasks = result.data;
          const taskListDiv = document.getElementById('task-list');
          taskListDiv.innerHTML = ""; // 기존 체크리스트 초기화
          taskSelections = {}; // 체크 상태 초기화

          const latestTasks = {}; // 동일한 업무의 최신 체크만 저장
          tasks.forEach(task => {
            latestTasks[task.task_name] = task;
          });

          Object.values(latestTasks).forEach(task => {
            const taskItem = document.createElement('div');
            const checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.checked = task.is_checked;
            checkbox.dataset.taskName = task.task_name;
            checkbox.onchange = () => taskSelections[task.task_name] = checkbox.checked;

            // 날짜 정보는 출력하지 않고 작업 이름만 표시
            const label = document.createElement('label');
            label.textContent = task.task_name;
            label.style.marginLeft = "5px";

            taskItem.appendChild(checkbox);
            taskItem.appendChild(label);
            taskListDiv.appendChild(taskItem);

            // 초기 체크 상태 저장
            taskSelections[task.task_name] = task.is_checked;
          });
        } else {
          document.getElementById('task-list').innerText = "체크리스트를 불러오지 못했습니다.";
        }
      } catch (error) {
        document.getElementById('task-list').innerText = "오류 발생: " + error;
      }
    }

    // ✅ 체크리스트 저장 버튼 클릭 시 DB에 새로운 기록 추가
    async function saveTaskSelections() {
      const updates = Object.keys(taskSelections).map(taskName => ({
        task_name: taskName,
        is_checked: taskSelections[taskName]
      }));

      console.log("보내는 데이터:", JSON.stringify({ updates }));

      try {
        const response = await fetch('/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ updates })
        });
        const result = await response.json();
        if(response.ok && result.success) {
          alert(result.message);
          fetchTasks(); // 저장 후 최신 체크리스트로 갱신
        } else {
          alert("체크리스트 저장에 실패했습니다.");
        }
      } catch (error) {
        alert("오류 발생: " + error);
      }
    }

    // 페이지 로드 시 체크리스트 불러오기
    fetchTasks();

    
// 이슈사항 저장 함수
    async function saveIssue() {
      const issueText = document.getElementById('issue-text').value;

      if (!issueText) {
        alert("이슈 사항을 입력하세요.");
        return;
      }

      try {
        const response = await fetch('/issues', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ issue: issueText })
        });

        const result = await response.json();
        if (result.success) {
          alert("이슈 사항이 저장되었습니다.");
          document.getElementById('issue-text').value = ""; // 입력란 초기화
        } else {
          alert("이슈 사항 저장에 실패했습니다.");
        }
      } catch (error) {
        alert("서버 오류: " + error);
      }
    }

      // ✅ 미체크 항목 설명 저장 함수
  async function saveUncheckedDescription() {
    const uncheckedDescription = document.getElementById('unchecked-description-text').value;

    if (!uncheckedDescription) {
      alert("미체크 항목 설명을 입력하세요.");
      return;
    }

    try {
      const response = await fetch('/unchecked_descriptions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: uncheckedDescription })
      });

      const result = await response.json();
      if (result.success) {
        alert("미체크 항목 설명이 저장되었습니다.");
        document.getElementById('unchecked-description-text').value = ""; // 입력란 초기화
      } else {
        alert("저장에 실패했습니다.");
      }
    } catch (error) {
      alert("서버 오류: " + error);
    }
  }

  </script>
</body>
</html>
