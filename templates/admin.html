<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드</title>
  <style>
    body { font-family: Arial, sans-serif; }
    section { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; }
    .section-title { font-weight: bold; margin-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: center; }
    textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; }
    .comment-box { margin-top: 10px; }
    .comment-box textarea { width: 100%; height: 50px; }
    .comment-item { border-left: 3px solid #ddd; padding-left: 10px; margin-top: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>관리자 대시보드</h1>

  <!-- 업무 현황 테이블 -->
  <section id="task-status-section">
    <div class="section-title">업무 현황</div>
    <table>
      <thead>
        <tr>
          <th>과정</th>
          <th>업무 완료율</th>
          <th>긴급업무</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>데이터 분석 스쿨</td>
          <td>80%</td>
          <td>긴급</td>
          <td>진행 중</td>
        </tr>
        <tr>
          <td>클라우드 스쿨</td>
          <td>60%</td>
          <td>일반</td>
          <td>대기 중</td>
        </tr>
        <tr>
          <td>게임 스쿨</td>
          <td>50%</td>
          <td>긴급</td>
          <td>진행 중</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- 전달사항 텍스트 입력란 -->
  <section id="remarks-section">
    <div class="section-title">전달사항</div>
    <textarea id="remarks" placeholder="여기에 전달사항을 적어주세요."></textarea>
  </section>
  
  <button onclick="saveRemarks()">저장</button>

  <script>
    async function saveRemarks() {
      const remarks = document.getElementById('remarks').value;

      if (!remarks) {
        alert("전달사항을 입력해주세요.");
        return;
      }

      try {
        const response = await fetch('/remarks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ remarks })  
        });
        
        const result = await response.json();
        if (response.ok && result.success) {
          alert('전달사항이 저장되었습니다.');
        } else {
          alert('전달사항 저장에 실패했습니다.');
        }
      } catch (error) {
        console.error("Error saving remarks:", error);
        alert('서버에 오류가 발생했습니다.');
      }
    }
  </script>

  <!-- 이슈사항 표시 섹션 -->
  <section id="issue-display-section">
    <div class="section-title">이슈사항 목록</div>
    <div id="issue-list"></div>
  </section>

  <section id="issue-download-section">
    <div class="section-title">이슈사항 다운로드</div>
    <button onclick="downloadIssues()">Excel 다운로드</button>
  </section>

  <script>
    async function resolveIssue(issueId) {
        try {
            const response = await fetch('/issues/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ issue_id: issueId })
            });

            const result = await response.json();
            if (result.success) {
                alert("이슈가 해결되었습니다.");
                fetchIssues();
            } else {
                alert("이슈 해결에 실패했습니다.");
            }
        } catch (error) {
            console.error("이슈 해결 오류:", error);
        }
    }

    async function fetchIssues() {
        try {
            const response = await fetch('/issues');
            const result = await response.json();

            if (result.success) {
                const issueListDiv = document.getElementById('issue-list');
                issueListDiv.innerHTML = "";

                result.data.forEach(issue => {
                    const issueItem = document.createElement('div');
                    issueItem.innerHTML = `
                        <p><strong>이슈:</strong> ${issue.content}</p>
                        <small>작성일: ${issue.created_at}</small>
                        <button onclick="resolveIssue(${issue.id})">해결</button>
                        <div id="comments-${issue.id}" class="comments-section"></div>
                        <div class="comment-box">
                            <textarea id="comment-text-${issue.id}" placeholder="댓글을 입력하세요"></textarea>
                            <button onclick="addComment(${issue.id})">댓글 추가</button>
                        </div>
                        <hr>
                    `;
                    issueListDiv.appendChild(issueItem);
                    fetchComments(issue.id);
                });
            } else {
                document.getElementById('issue-list').innerText = "이슈사항을 불러오지 못했습니다.";
            }
        } catch (error) {
            document.getElementById('issue-list').innerText = "오류 발생: " + error;
        }
    }

    async function fetchComments(issueId) {
      try {
        const response = await fetch(`/issues/comments?issue_id=${issueId}`);
        const result = await response.json();

        if (result.success) {
          const commentsDiv = document.getElementById(`comments-${issueId}`);
          commentsDiv.innerHTML = "";  

          result.data.forEach(comment => {
            const commentItem = document.createElement('div');
            commentItem.classList.add('comment-item');
            commentItem.innerHTML = `<strong>관리자:</strong> ${comment.comment} <small>${comment.created_at}</small>`;
            commentsDiv.appendChild(commentItem);
          });
        }
      } catch (error) {
        console.error("댓글 불러오기 오류:", error);
      }
    }

    async function addComment(issueId) {
      const commentText = document.getElementById(`comment-text-${issueId}`).value;

      if (!commentText) {
        alert("댓글을 입력하세요.");
        return;
      }

      try {
        const response = await fetch('/issues/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ issue_id: issueId, comment: commentText })
        });

        const result = await response.json();
        if (result.success) {
          alert("댓글이 추가되었습니다.");
          fetchComments(issueId);
          document.getElementById(`comment-text-${issueId}`).value = "";  
        } else {
          alert("댓글 추가에 실패했습니다.");
        }
      } catch (error) {
        console.error("댓글 추가 오류:", error);
      }
    }

    fetchIssues();
  
    async function downloadIssues() {
      try {
        const response = await fetch('/issues/download');
        if (!response.ok) throw new Error('이슈 다운로드 실패');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "이슈사항.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error("다운로드 오류:", error);
        alert("이슈사항 다운로드에 실패했습니다.");
      }
    }
  </script>

  <!-- 미체크 항목 설명 표시 섹션 -->
  <section id="unchecked-description-display-section">
    <div class="section-title">미체크 항목 설명</div>
    <div id="unchecked-descriptions"></div>
  </section>

  <script>
    async function fetchUncheckedDescriptions() {
      try {
        const response = await fetch('/unchecked_descriptions');
        const result = await response.json();
        if (result.success) {
          const descriptionsDiv = document.getElementById('unchecked-descriptions');
          descriptionsDiv.innerHTML = "";
          result.data.forEach((desc, index) => {
            const descItem = document.createElement('div');
            descItem.innerHTML = `<p><strong>${index + 1}. </strong>${desc}</p>`;
            descriptionsDiv.appendChild(descItem);
          });
        } else {
          document.getElementById('unchecked-descriptions').innerText = "미체크 항목 설명이 없습니다.";
        }
      } catch (error) {
        console.error("오류 발생:", error);
        document.getElementById('unchecked-descriptions').innerText = "데이터를 불러오는 중 오류가 발생했습니다.";
      }
    }
    fetchUncheckedDescriptions();
  </script>
</body>
</html>